<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Aprendendo TDD na prática</title>
    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.18.0.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
</head>

<body>
    <div id='main' style='padding: 2em;'>
        <h1>Calculadora de troco de uma máquina de venda com estoque de cedula limitado</h1>
        <h2>Calcule o troco de acordo com o preço do produto e dinheiro recebido</h2>
    </div>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="https://code.jquery.com/qunit/qunit-1.18.0.js"></script>

    <script>
        const calcularTroco = (precoDoProduto, valorPago, estoqueCedulas) => {
            let valorRestante = valorPago - precoDoProduto;
            const troco = [];

            // Pega apenas as cédulas disponíveis, do maior para o menor
            const cedulasDisponiveis = Object.entries(estoqueCedulas)
                .filter(([_, quantidade]) => quantidade > 0)
                .map(([cedula]) => Number(cedula))
                .sort((a, b) => b - a);

            for (const cedula of cedulasDisponiveis) {
                let quantidadeDisponivel = estoqueCedulas[cedula];
                while (valorRestante >= cedula && quantidadeDisponivel > 0) {
                    valorRestante -= cedula;
                    troco.push(cedula);
                    quantidadeDisponivel--;
                }
                estoqueCedulas[cedula] = quantidadeDisponivel; // Atualiza estoque
            }

            if (valorRestante > 0) {
                throw new Error("Não há cédulas suficientes para fornecer o troco.");
            }

            return troco;
        };
    </script>


    <script>
        const estoqueCedulasTest1 = {
            100: 1,
            50: 0,
            20: 5,
            10: 10,
            5: 0,
            2: 0,
            1: 0
        };
        const estoqueVazio = {
            100: 0,
            50: 0,
            20: 0,
            10: 0,
            5: 0,
            2: 0,
            1: 0
        };
        const checkEstoque = (cedulasDisponiveis, cedula) => {
            // checa se a cedula é valida, se está no dentro estoque disponivel
            if (cedulasDisponiveis[cedula] && cedulasDisponiveis[cedula] > 0) {
                cedulasDisponiveis[cedula]--;
                return true;
            }
            return false;
        }
        const sum = (amostras) => {
            return amostras.reduce((acumulador, valorAtual) => acumulador + valorAtual, 0);
        }
        test('calcularTroco(120, 200) deve retornar 80, se possuir as cedulas necessarias', (assert) => {
            const resultado = calcularTroco(120, 200, { ...estoqueCedulasTest1 });
            assert.ok(resultado.every(cedula => checkEstoque({ ...estoqueCedulasTest1 }, cedula)));
            const trocoResultado = sum(resultado);
            const trocoEsperado = 80;
            assert.equal(trocoResultado, trocoEsperado);
        });
        test('calcularTroco(5, 10) deve retornar 5, se possuir as cedulas necessarias', (assert) => {
            assert.throws(
                () => calcularTroco(5, 10, estoqueVazio),
                /Não há cédulas suficientes/,
                "A função deve lançar um erro quando não há cédulas suficientes para o troco"
            );
        });
    </script>

</body>

</html>